{% extends 'base.html' %}
{% load static %}
{% load template_tags %}
{% load crispy_forms_tags %}
{% load form_helper %}

{% block title_page %}
{{title_page}}
{% endblock title_page %}

{% block css %}

{% endblock css %}

{% block navigation %}

{% endblock navigation %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex flex-row justify-content-between">
            <div class="d-flex flex-row">
                <p class="h4">{{title}}</p>
            </div>
            <div>
            {% if request.user.is_superuser %}
                <a class="btn btn-outline-primary" href="{% url 'disiplinsdm_urls:harilibur_list' %}">Libur</a>
                <a class="btn btn-outline-primary" href="{% url 'disiplinsdm_urls:kehadiran_list' %}">Kehadiran</a>
                <a href="{% url 'disiplinsdm_urls:salin_jadwal' %}" class="btn btn-outline-secondary">Copy jadwal</a>
                <a href="{% url 'disiplinsdm_urls:salin_jadwal_instalasi' %}" class="btn btn-outline-warning">Copy instalasi</a>
                <a href="{% url 'disiplinsdm_urls:evaluasi_jadwal' %}" class="btn btn-outline-success">Cek Status Jadwal</a>
            {% elif request.user.is_staff %}
                <a href="{% url 'disiplinsdm_urls:salin_jadwal' %}" class="btn btn-outline-secondary">Copy jadwal</a>
                <a href="{% url 'disiplinsdm_urls:salin_jadwal_instalasi' %}" class="btn btn-outline-warning">Copy jadwal instalasi</a>
                <a href="{% url 'disiplinsdm_urls:evaluasi_jadwal' %}" class="btn btn-outline-success">Cek Status Jadwal</a>
                <a class="btn btn-outline-primary" href="{% url 'disiplinsdm_urls:kehadiran_list' %}">Kehadiran</a>
            {% else %}
            <a class="btn btn-outline-primary" href="{% url 'disiplinsdm_urls:kehadiran_list' %}">Kehadiran</a>
            {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if request.user.is_staff %}
        <div class="row">
            <div class="col-md-12 border rounded mb-4 p-3">
                <div class="row">
                    <div class="col-md-8">
                        <form method="get">
                            <div class="row">
                                <div class="col-md-6">
                                    {% load tz %}
                                    {% if request.GET.tanggal %}
                                        {% with request.GET.tanggal as current_date %}
                                            <input type="date" name="tanggal" class="form-control"
                                                value="{{ current_date }}" onchange="this.form.submit();">
                                        {% endwith %}
                                    {% else %}
                                        <input type="date" name="tanggal" class="form-control"
                                            value="{% now 'Y-m-d' %}" onchange="this.form.submit();">
                                    {% endif %}
                                    <small class="text-muted">Abaikan tanggal dalam form ini.</small>
                                </div>
                                <div class="col-md-6">
                                    <select name="nip" class="form-control sdm" onchange="this.form.submit();" style="width: 100%;">
                                        {% if selected_user %}
                                        <option value="{{selected_user.profil_user.nip}}">{{selected_user.full_name}}</option>
                                        {% else %}
                                        <option value="">---Pilih Pegawai---</option>
                                        {% endif %}
                                        {% for user in users %}
                                        <option value="{{user.profil_user.nip}}">{{user.full_name}}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Form ini hanya untuk menambahkan jadwal baru, bukan untuk filter pegawai</small>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-3 ml-1">
                        <form method="post">
                            {% csrf_token %}
                            {{form|crispy}}
                            {% if selected_user %}
                            <input type="submit" value="Submit" class="btn btn-outline-primary">
                            {% else %}
                            <input type="submit" value="Simpan" class="btn btn-outline-primary" disabled>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div> 
        {% endif %}
        <div class="row">
            <div class="col-md-9">
                {% if request.user.is_superuser %}
                <div class="form-group row">
                    <div class="col-md-3">Bidang/Instalasi</div>
                    <div class="col-md-9">Semua Instalasi/Unit/Subbagian</div>
                </div>
                {% else %}
                <div class="form-group row">
                    <div class="col-md-3">Bidang/Instalasi</div>
                    <div class="col-md-9">
                        {% if request.user.profil_admin.instalasi.exists %}
                            {% for inst in request.user.profil_admin.instalasi.all %}
                                {{ inst.instalasi }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        {% elif request.user.profil_admin.sub_bidang %}
                            {{request.user.profil_admin.sub_bidang}}
                        {% elif request.user.profil_admin.bidang %}
                            {{request.user.profil_admin.bidang}}
                        {% elif request.user.profil_admin.unor %}
                            {{request.user.profil_admin.unor}}
                        {% else %}
                            {{instalasi.instalasi}}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <div class="form-group row">
                    <div class="col-md-3">Bulan/Tahun</div>
                    {% if bulan %}
                    <div class="col-md-9">{{bulan|month_name}} {{tahun}}</div>
                    {% else %}
                    <div class="col-md-9">N/A</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3">
                {% if instalasi %}
                    <a href="{% url 'disiplinsdm_urls:jadwal_pivot' inst=instalasi.pk %}?bulan={{bulan}}&tahun={{tahun}}" class="btn btn-secondary"><i class="fas fa-table mr-1"></i>Verifikasi/Jadwal Tabel</a>
                {% else %}
                    <button class="btn btn-secondary btn-sm" disabled><i class="fas fa-table"></i>Verifikasi/Jadwal Tabel</button>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="row d-flex justify-content-end mr-3">
                    <div class="mb-2">
                        <form method="get">
                            <div class="d-flex flex-row">
                                <input type="text" name="q" class="form-control mr-2 flex-grow-1"
                                    placeholder="Cari text..." value="{{ request.GET.q }}">
                                <select name="inst" class="form-control ml-2 mr-2">
                                    <option value="">--- Instalasi ---</option>
                                    {% for item in instalasi_list %}
                                        <option value="{{item.id}}" {% if request.GET.inst == item.id|stringformat:"s" %}selected{% endif %}>{{item.instalasi}}</option>
                                    {% endfor %}
                                </select>
                                <select name="bulan" class="form-control ml-2 mr-2">
                                    <option value="">--- Bulan ---</option>
                                    {% for value, label in bulan_list %}
                                        <option value="{{ value }}" {% if request.GET.bulan == value|stringformat:"s" %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>

                                <select name="tahun" class="form-control mr-2">
                                    <option value="">--- Tahun ---</option>
                                    {% for t in tahun_list %}
                                        <option value="{{ t }}" {% if request.GET.tahun == t|stringformat:"s" %}selected{% endif %}>{{ t }}</option>
                                    {% endfor %}
                                </select>
                                <div class="ml-2"><button class="btn btn-outline-info btn-sm">Cari</button></div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="d-flex justify-content-end align-items-center flex-wrap">
                    <div class="d-flex align-items-center mr-3 mb-2">
                        <div class="bg-warning" style="width: 20px; height: 20px; border: 1px solid #ccc;"></div>
                        <span class="ml-2">Draft</span>
                    </div>

                    <div class="d-flex align-items-center mr-3 mb-2">
                        <div class="bg-secondary" style="width: 20px; height: 20px; border: 1px solid #ccc;"></div>
                        <span class="ml-2">Diusulkan</span>
                    </div>

                    <div class="d-flex align-items-center mr-3 mb-2">
                        <div class="" style="width: 20px; height: 20px; border: 1px solid #ccc; background-color: white;"></div>
                        <span class="ml-2">Disetujui</span>
                    </div>

                    <div class="d-flex align-items-center mr-3 mb-2">
                        <div class="bg-danger" style="width: 20px; height: 20px; border: 1px solid #ccc;"></div>
                        <span class="ml-2">Ditolak</span>
                    </div>
                </div>

                <div class="table table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="text-center align-middle">No</th>
                                <th rowspan="2" class="text-center align-middle">Nama Pegawai</th>
                                <th rowspan="2" class="text-center align-middle">Profesi</th>
                                <th rowspan="2" class="text-center align-middle">Bulan/Tahun</th>
                                <th colspan="3" style="text-align:center;">Jam Kerja</th>
                                <th rowspan="2" class="text-center align-middle">Aksi</th>
                            </tr>
                            <tr>
                                <th>Jumlah</th>
                                <th>Standar</th>
                                <th>Selisih</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in object_list %}
                            <tr class="{% if item.status == 'draft' %} table-warning {% elif item.status == 'diajukan' %} table-secondary {% elif item.status == 'ditolak' %} table-danger {% endif %} ">
                                <td>{{forloop.counter|add:page_obj.start_index|add:"-1"}}</td>
                                <td>{{item.pegawai.full_name}}</td>
                                <td>{{item.jenis_sdm}}</td>
                                <td>{{item.bulan}}/{{item.tahun}}</td>
                                <td>{{item.kurang_lebih_jam_kerja}} jam</td>
                                <td>{{item.standar_min_efektif}} s/d {{item.standar_max_efektif}} jam</td>
                                <td>
                                    {% if item.kurang_lebih_jam_kerja < item.standar_min_efektif  %}
                                        <span class="badge badge-danger">{{item.selisih_jam_kerja}}</span>
                                    {% elif item.standar_min_efektif <= item.kurang_lebih_jam_kerja and item.kurang_lebih_jam_kerja <= item.standar_max_efektif %}
                                        <span class="badge badge-success">{{item.selisih_jam_kerja}}</span>
                                    {% elif item.kurang_lebih_jam_kerja > item.standar_max_efektif %}
                                        <span class="badge badge-info">{{item.selisih_jam_kerja}}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.user.is_staff %}
                                    {% querystring_filter 'q' 'inst' 'bulan' 'tahun' as filtered_query %}
                                        <a href="{% url 'disiplinsdm_urls:jadwal_auto_create' pk=item.id %}{% if filtered_query %}?{{filtered_query}}{% endif %}" class="btn btn-primary btn-sm mr-1 mb-1"><i class="fas fa-info"></i></a>
                                        <a href="{% url 'disiplinsdm_urls:jadwal_detail' pk=item.id %}{% if filtered_query %}?{{filtered_query}}{% endif %}" class="btn btn-info btn-sm mr-1 mb-1"><i class="fas fa-binoculars"></i></a>
                                        {% if item.status == 'diajukan' %}
                                            <a href="{% url 'disiplinsdm_urls:setujui_jadwal' pk=item.pk %}{% if filtered_query %}?{{filtered_query}}{% endif %}" class="btn btn-success btn-sm mr-1 mb-1"><i class="far fa-check-circle"></i></a>
                                        {% endif %}
                                        <a href="{% url 'disiplinsdm_urls:jadwal_update_view' pk=item.id %}{% if filtered_query %}?{{filtered_query}}{% endif %}" class="btn btn-warning btn-sm mr-1 mb-1"><i class="fas fa-edit"></i></a>
                                        <a href="{% url 'disiplinsdm_urls:jadwal_delete_view' id=item.id %}{% if filtered_query %}?{{filtered_query}}{% endif %}" class="btn btn-danger btn-sm mr-1 mb-1"><i class="fas fa-trash-alt"></i></a>
                                    {% else %}
                                        <a href="{% url 'disiplinsdm_urls:jadwal_detail' pk=item.id %}{% if filtered_query %}?{{filtered_query}}{% endif %}" class="btn btn-primary btn-sm mr-1 mb-1" btn-sm><i class="fas fa-binoculars"></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>    
            </div>
            <div class="col-md-12">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ preserved_query }}&page=1">« First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{{ preserved_query }}&page={{ page_obj.previous_page_number }}">‹ Prev</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">« First</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">‹ Prev</span>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active" aria-current="page">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                                <li class="page-item">
                                    <a class="page-link" href="?{{ preserved_query }}&page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ preserved_query }}&page={{ page_obj.next_page_number }}">Next ›</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{{ preserved_query }}&page={{ page_obj.paginator.num_pages }}">Last »</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next ›</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Last »</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
    <script>
    $(document).ready(function () {
        $('#data_table').DataTable({
            dom: 'Blfrtip',
            buttons: [
                'copy', 'csv', 'excel', 'pdf'
            ],
            lengthMenu: [
                [10, 25, 50, -1],
                [10, 25, 50, 'All'],
            ],
        });
    });

    $(document).ready(function() {
        $('.sdm').select2();
        selectOnClose: true
    });
</script>
{% endblock %}
                    