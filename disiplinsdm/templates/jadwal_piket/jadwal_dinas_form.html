{% extends 'base.html' %}
{% load static %}
{% load template_tags %}
{% load crispy_forms_tags %}
{% load form_helper %}

{% block title_page %}
{{title_page}}
{% endblock title_page %}

{% block css %}

{% endblock css %}

{% block navigation %}

{% endblock navigation %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="d-flex flex-row justify-content-between">
      <div class="d-flex flex-row mb-1">
        {% querystring_filter 'q' 'inst' 'bulan' 'tahun' as filtered_query %}
          <div>
              <a href="{{url}}{% if filtered_query %}?{{ filtered_query }}{% endif %}"><i class="fas fa-chevron-left mr-3 pt-1" style="font-size:x-large;"></i></a>
          </div>
        <p class="h4">{{ title }}</p>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-12">
        <div class="form-group row">
          <label for="nama" class="col-2">Nama Pegawai</label>
          <div class="col-9">{{object.pegawai}}</div>
        </div>
        <div class="form-group row">
          <label for="nama" class="col-2">Profesi</label>
          <div class="col-9">{{object.jenis_sdm}}</div>
        </div>
      </div>
    </div>
    <hr>
    <form method="post">
      {% csrf_token %}
      {{ formset.management_form }}

      <div id="accordion">
        {% for minggu in minggu_formsets %}
          <div class="card">
            <div class="card-header" id="heading{{ forloop.counter }}">
              <h5 class="mb-0">
                <button class="btn btn-link {% if not forloop.first %}collapsed{% endif %}" type="button"
                  data-toggle="collapse" data-target="#collapse{{ forloop.counter }}"
                  aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                  aria-controls="collapse{{ forloop.counter }}">
                  Minggu {{ forloop.counter }} ({{ minggu.range.0 }} â€“ {{ minggu.range|last }})
                </button>
              </h5>
            </div>

            <div id="collapse{{ forloop.counter }}" class="collapse {% if forloop.first %}show{% endif %}"
              aria-labelledby="heading{{ forloop.counter }}" data-parent="#accordion">
              <div class="card-body">

                {% for hari in minggu.data_harian %}
                  <h6 class="d-flex justify-content-between">
                    {{ hari.tanggal|date:"l, d M Y" }}
                    <a href="?shift_tanggal={{ hari.tanggal|date:'Y-m-d' }}" class="btn btn-sm btn-success">+ Shift</a>
                  </h6>

                  <table class="table table-sm table-bordered">
                    <thead>
                      <tr>
                        <th>Kategori</th>
                        <th>Jam</th>
                        <th>Catatan</th>
                        <th>Hapus</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for f in hari.forms %}
                      {{ f.id }}  {# penting! supaya formset tahu ini instance existing #}
                      {{ f.tanggal.as_hidden }}  {# tanggal juga harus dikirim walau hidden #}
                      <tr>
                        <td>{{ f.kategori_jadwal }}</td>
                        <td>
                          {% if f.instance.kategori_jadwal %}
                            {% if f.instance.kategori_jadwal.waktu_datang %}
                              {{ f.instance.kategori_jadwal.waktu_datang }}
                            {% else %}
                              N/A
                            {% endif %} - {% if f.instance.kategori_jadwal.waktu_pulang %}
                              {{ f.instance.kategori_jadwal.waktu_pulang }}
                            {% else %}
                              N/A
                            {% endif %}
                          {% else %}-{% endif %}
                        </td>
                        <td>{{ f.catatan }}</td>
                        <td>{{ f.DELETE }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>

                  <div class="text-right small mb-3">
                    Total jam hari ini: <strong>{{ hari.total_jam }} jam</strong>
                  </div>
                {% endfor %}

                <div class="text-right small mt-2">
                  Total jam: <strong>{{ minggu.total_jam }} jam</strong>
                  {% if minggu.total_jam < 39 %}
                    <span class="badge badge-primary">Ringan ðŸ”µ</span>
                  {% elif minggu.total_jam <= 40 %}
                    <span class="badge badge-success">Ideal ðŸŸ¢</span>
                  {% else %}
                    <span class="badge badge-danger">Overload ðŸ”´</span>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="text-right font-weight-bold mt-4">
        Total jam kerja bulan ini: {{ total_bulanan }} jam
      </div>
      {% if object.status == 'ditolak' and object.alasan_penolakan %}
        <div class="alert alert-danger mt-3">
          <strong>Alasan Penolakan:</strong><br>
          {{ object.alasan_penolakan }}
        </div>
    {% endif %}

      <button type="submit" name="simpan_draft" class="btn btn-primary mt-3">Simpan sebagai draft</button>
      <button type="submit" name="ajukan" class="btn btn-success mt-3">Ajukan</button>
    </form>
  </div>
</div>
{% endblock content %}